name: Build Android

on:
  push:
    branches:
      - android
      - 'android/**'
  pull_request:
    branches:
      - android

jobs:
  build-android:
    name: Android arm64-v8a
    runs-on: ubuntu-24.04

    env:
      ANDROID_ABI: arm64-v8a
      ANDROID_API: 28
      BUILD_DIR: build/arm64-v8a

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build wget unzip git build-essential python3 libssl-dev zip

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          yes | sdkmanager --licenses >/dev/null
          sdkmanager "platform-tools" \
                     "build-tools;34.0.0" \
                     "platforms;android-${ANDROID_API}" \
                     "ndk;28.2.13676358"

      - name: Set NDK path
        run: |
          NDK_PATH=$(ls -d $ANDROID_HOME/ndk/* | sort -r | head -n 1)
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "Using NDK at $NDK_PATH"

      - name: Cache Boost and OpenSSL
        uses: actions/cache@v4
        with:
          path: |
            ~/opt/android/boost
            ~/opt/android/openssl
          key: android-prebuilts-arm64-boost178-openssl111k

      - name: Fetch Boost 1.78 prebuilt
        run: |
          git clone --depth 1 -b boost-1_78_0 https://github.com/PurpleI2P/Boost-for-Android-Prebuilt.git $HOME/opt/android/boost
          echo "BOOST_ROOT=$HOME/opt/android/boost/boost-1_78_0" >> $GITHUB_ENV
          echo "BOOST_INCLUDEDIR=$HOME/opt/android/boost/boost-1_78_0/include/boost" >> $GITHUB_ENV
          echo "BOOST_LIBRARYDIR=$HOME/opt/android/boost/boost-1_78_0/$ANDROID_ABI/lib" >> $GITHUB_ENV

      - name: Fetch OpenSSL prebuilt
        run: |
          git clone --depth 1 https://github.com/PurpleI2P/OpenSSL-for-Android-Prebuilt.git ${HOME}/opt/android/openssl
          echo "OPENSSL_ROOT=${HOME}/opt/android/openssl/openssl-1.1.1k-clang" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          set -x
          rm -rf $BUILD_DIR && mkdir -p $BUILD_DIR
          cd $BUILD_DIR

          export CC=clang
          export CXX=clang++
          export CFLAGS='-stdlib=libc++'

          cmake ../.. \
            -DCMAKE_TOOLCHAIN_FILE=$NDK_PATH/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=$ANDROID_ABI \
            -DANDROID_PLATFORM=android-$ANDROID_API \
            -DANDROID_NATIVE_API_LEVEL=$ANDROID_API \
            -DANDROID_TOOLCHAIN=clang \
            -DSTATIC=ON \
            -DANDROID=true \
            -DOPENSSL_ROOT_DIR=$OPENSSL_ROOT \
            -DOPENSSL_SSL_LIBRARY=$OPENSSL_ROOT/$ANDROID_ABI/lib/libssl.a \
            -DOPENSSL_CRYPTO_LIBRARY=$OPENSSL_ROOT/$ANDROID_ABI/lib/libcrypto.a \
            -DOPENSSL_INCLUDE_DIR=$OPENSSL_ROOT/include \
            -DBoost_THREADAPI=pthread \
            -DBOOST_ROOT=$BOOST_ROOT \
            -DBOOST_INCLUDEDIR=$BOOST_INCLUDEDIR \
            -DBOOST_LIBRARYDIR=$BOOST_LIBRARYDIR \
            -DBoost_NO_SYSTEM_PATHS=ON \
            -DBoost_USE_STATIC_LIBS=ON \
            -DBoost_USE_STATIC_RUNTIME=ON \
            -DBoost_DEBUG=ON \
            -DCMAKE_FIND_PACKAGE_PREFER_CONFIG=OFF \
            -DCMAKE_POLICY_DEFAULT_CMP0074=NEW \
            -DCMAKE_POLICY_DEFAULT_CMP0144=OLD \
            -DCMAKE_POLICY_DEFAULT_CMP0167=OLD \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_VERBOSE_MAKEFILE=ON \
            -G Ninja

      - name: Build binaries
        run: |
          cd $BUILD_DIR
          ninja

      - name: Package binaries
        run: |
          cd $BUILD_DIR/src
          mkdir -p karbo-$ANDROID_ABI
          for bin in karbowanecd simplewallet greenwallet optimizer walletd vanitygen; do
            if [ -f "$bin" ]; then
              strip "$bin" || true
              cp "$bin" karbo-$ANDROID_ABI/
            fi
          done
          cd karbo-$ANDROID_ABI
          zip -r ../karbo-$ANDROID_ABI.zip .
          echo "artifact_path=$BUILD_DIR/src/karbo-$ANDROID_ABI.zip" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: karbo-${{ env.ANDROID_ABI }}
          path: build/arm64-v8a/src/karbo-arm64-v8a.zip
